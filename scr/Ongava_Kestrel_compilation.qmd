---
title: "OngavaDecomp Kestrel Data"
author: "Heather Throop"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

Data compilation of Kestrel data from Ongava for the decomposition experiment (2024-2026)

# Overview

This script reads in csv files from individual Kestrel loggers, merges the files, and synthesizes the data.

Created January 24, 2025 Heather Throop

To run this code, all raw Kestrel files should be placed within the "L0" folder for this project on Dropbox. This code pulls data from the Dropbox folder.

Install Packages

```{r}
#| label: load-packages
library(here) # v. 0.1
library(stringr) # v. 1.2.0
library(purrr) # v. 0.2.3
library(tidyverse)
library(scales)
```

Display information about package versions in use when this code was run.

```{r}
#| label: session-info
sessionInfo()
```

# Read and Clean Data

### List Kestrel Files

Note that the "more columns than column names" error is likely to happen. Find the offending file (use the last line of code in this chunk to do so) and delete extra columns to the right of the data.\
\
Much of this code is based on the commentary from: https://aosmith.rbind.io/2017/12/31/many-datasets/

```{r}
# list all files to read in
### Note that this reference from Heather's laptop and may need to be changed for a different machine
allfiles <- list.files(
  path = file.path("/Users/hthroop/ASU Dropbox/Heather Throop/DERT (ThroopLab) ASU/Lab Data & Metadata Archives/OngavaDungDecay/MicroclimateData/L0"),  
  pattern = "\\.csv$",  # Ensure proper regex for .csv files  
  full.names = TRUE  
)

# reading and extract loggerID
read_fun = function(path) {
  test = read.csv(path, 
                  skip = 5,
                  header = FALSE,
                  col.names = c("datetime", "temperature", "RH", "heatindex", "dewpoint", "datatype") )
  allnames = str_split( path, pattern = "/", simplify = TRUE)
 test$loggerID = str_extract(allnames[, ncol(allnames)], pattern = "2[0-9][0-9][0-9][0-9][0-9][0-9]") #extract the loggerID from the file name and add as a column
  test$RH <- as.numeric(as.character(test$RH))
  test$heatindex <- as.numeric(as.character(test$heatindex))
  test$dewpoint <- as.numeric(as.character(test$dewpoint))
  test$temperature <- as.numeric(as.character(test$temperature))
  test$loggerID <- as.numeric(as.character(test$loggerID))
  test
}

# Line below is useful for testing if logger name is being assigned
# change the number in brackets to check show the top section of each file
read_fun(allfiles[1]) # use to test the function on an individual file
```

### Read in and Combine Files

```{r}
#| label: combine-kestrel-files
combined_kestrel_notcleaned = map_dfr(allfiles, read_fun) # combine all the files

# check that we have the right number of loggers in the file
combined_kestrel_notcleaned |>
  group_by(loggerID) |> 
  summarize(n = n())

# Add in microsite and block information
### pulls in file with loggerID information ("KestrelLoggerAssignments")
df_loggers <- read.csv("https://www.dropbox.com/scl/fi/25mbe4f5g30nbrgfwn1of/KestrelLoggerAssignments.csv?rlkey=d2djvhf8jkq3hpv7yvoez2zoy&dl=1", header = TRUE)
df_loggers$loggerID <- as.numeric(df_loggers$loggerID)
combined_kestrel_notcleaned <- combined_kestrel_notcleaned |>
  left_join(df_loggers, join_by(loggerID))

```

### 
