---
title: "OngavaDungMassLoss"
author: "Heather Throop"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Overview

This analysis script performs corrections on litter mass data from the Ongava Dung Decay experiment. The corrections include wet-dry correction, transport loss correction, and ash correction. The corrected mass data is then plotted to explore decomposition rates.

### Variable Names

#### Experimental design variables

`LitterbagID`: The unique identifier for each litterbag used in the experiment. Allowable values = M001 to M102 for mopane samples and D001 to D102 for dung samples.

`LitterType`: The type of litter being analyzed. Allowable values = mopane and dung.

`Block`: The block assigned to the litterbag. Litterbags were deployed in blocks of co-located litterbags (see "Ongava litterbag maps.pptx" for details). Allowable values = A - F.

`Microsite`: The microsite assigned to the litterbag. Allowable values = tree, open, NA. Tree microsites were under mopane canopies and open microsites were in open areas without tree canopy cover. Time 0 litterbags were not assigned to microsites and are indicated as NA.

`WaterTrt`:The water treatment assigned to the block that the litterbag was in. Allowable values = Ctrl, Addition, and NA. Time 0 litterbags were not assigned to a water treatment and are indicated as NA.

`Location`: The relative location within a block assigned to the litterbag to help in locating the bags for future collections (see "Ongava litterbag maps.pptx" for details). Allowable values = 1 - 8, NA. Time 0 litterbags were not assigned to a water treatment and are indicated as NA.

`CollectionTime`: The time point assigned for the litterbag to be collected. Allowable values = 0 - 6, with each 1 unit corresponding to 3 months.

`CollectionDate`: The date the litterbag was collected from the field. Format = YYYY-MM-DD.

#### Measured variables

`LitterbagMass`: The mass of the litterbag at the start of the experiment. Allowable values = 2.5-4 for dung and NA for mopane. Units = g.

`Litterbag_Litter`: The mass of the litterbag and the wet litter within the litterbag at the start of the experiment. Allowable values = 30-45 for dung and NA for mopane. Units = g. Dung was weighed within a litterbag while mopane was weighed in a weigh boat and then transferred to a litterbag.

`InitialWetMass`: The initial wet mass of the litter at the start of the experiment. Allowable values = 27.5-41 for dung and 3-3.5 for mopane. This is a calculated varibale for dung and a measure variable for mopane. Units = g.

#### Calculated variables

`InitialDryMass`: The initial dry mass of the litter at the start of the experiment (after wet-dry correction). InitialDryMass = InitialWetMass x ProportionDry. Allowable values = XXX-XXX for dung and 2.5 - 3.4 for mopane. Units = g.

`FinalDryMass`: The final dry mass of the litter at the end of the experiment (after wet-dry correction).

## Preparation

```{r}
#| label: load-packages

library(tidyverse)
```

```{r}
#| label: config-setup

# This script uses a config.yml file to define the path for the DERT Data & Metadata folder (in Dropbox) where Heather has the data stored. This can be changed to your own path as needed or you can read in data from elsewhere, but you will need to update the read-in-files steps. 
DERT_Archives <- config::get()
```

```{r}
#| label: read-in-files

# Litter wet-dry mass data
WetDry <- read_csv(
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "WetDry.csv"), 
  show_col_types = FALSE)

# Litter mass data 
LitterMass <- read_csv(
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "LitterMass.csv"), 
  show_col_types = FALSE)

# Ash data
AshMass <- read_csv(
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "AshMass.csv"), 
  show_col_types = FALSE)
```

## Wet-Dry Correction

```{r}
#| label: calculate wet-dry

# Calculate dry mass and the wet-dry correction factor
WetDry <- WetDry |>
  mutate(WetMass = WetMassAndBag - BagMass,
    DryMass = DryMassAndBag - BagMass,
    ProportionDry = DryMass/WetMass)
```

```{r}
#| label: summarize wet-dry

# simple plot of wet-dry correction by litterbag number for each litter type
p1 <- WetDry |> 
  filter(LitterType == "mopane") |>
  ggplot(aes(x = LitterbagStart, y = ProportionDry)) +
    geom_point() +
    labs(x = "Litterbag Number", y = "Wet-Dry Correction Factor") +
    theme_minimal() +
    ggtitle("Wet-Dry Correction for Mopane Litterbags")
p1

p2 <- WetDry |> 
  filter(LitterType == "dung") |>
  ggplot(aes(x = LitterbagStart, y = ProportionDry)) +
    geom_point() +
    labs(x = "Litterbag Number", y = "Wet-Dry Correction Factor") +
    theme_minimal() +
    ggtitle("Wet-Dry Correction for Dung Litterbags")
p2

# summarize wet-dry correction factor by litter type
WetDry_Summary <- WetDry |>
  group_by(LitterType) |>
  summarize(
    WetDryCorrection = mean(ProportionDry, na.rm = TRUE),
    SD_WetDryCorrect = sd(ProportionDry, na.rm = TRUE),
    N = n(),
    SE_WetDryCorrect = SD_WetDryCorrect / sqrt(N)
  )

```

```{r}
#| label: apply wet-dry correction

LitterMass <- LitterMass |>
  left_join(
    WetDry_Summary |>
      select(LitterType, WetDryCorrection),
    by = "LitterType"
  ) |>
  mutate(
    InitialDryMass = InitialWetMass * WetDryCorrection)
```

## Transport Loss Correction

```{r}
#| label: plots to visualize transport loss

p3 <- LitterMass |> 
  filter(LitterType == "dung" & CollectionTime == 0) |>
  ggplot(aes(x = InitialDryMass, y = FinalDryMass)) +
    geom_point() +
    labs(x = "Initial Dry Mass (g)", y = "Final Dry Mass (g)") +
    theme_minimal() +
    ggtitle("Transport Loss for Dung Litterbags")
p3

p4 <- LitterMass |> 
  filter(LitterType == "mopane" & CollectionTime == 0) |>
  ggplot(aes(x = InitialDryMass, y = FinalDryMass)) +
    geom_point() +
    labs(x = "Initial Dry Mass (g)", y = "Final Dry Mass (g)") +
    theme_minimal() +
    ggtitle("Transport Loss for Mopane Litterbags")
p4

```

```{r}
#| label: calculate transport loss correction factor for each litter type

TransportLoss_Summary <- LitterMass |>
  filter(CollectionTime == 0) |>
  group_by(LitterType) |>
  summarize(
    TransportLossCorrection = mean(FinalDryMass / InitialDryMass, na.rm = TRUE),
    SD_TransportLossCorrect = sd(FinalDryMass / InitialDryMass, na.rm = TRUE),
    N = n(),
    SE_TransportLossCorrect = SD_TransportLossCorrect / sqrt(N)
  )

# box and whisker plot of transport correction by litter type
#p6 <- LitterMass |> 
#  filter(CollectionTime == 0) |>
#  ggplot(aes(x = LitterType, y = TransportLossCorrection)) +
#    geom_boxplot() +
#    labs(x = "Litter Type", y = "Transport Loss Correction Factor") +
#    theme_minimal() +
#    ggtitle("Transport Loss Correction by Litter Type")
#p6
```

```{r}
#| label: Transport loss correction
LitterMass <- LitterMass |>
  # first add a column with the litter specific transport loss correction factor
  left_join(
    TransportLoss_Summary |>
      select(LitterType, TransportLossCorrection),
    by = "LitterType"
  ) |>
  # then calculate the transport loss corrected initial dry mass
  mutate(
    InitialDryMass_TransportCorrected = InitialDryMass * TransportLossCorrection
  )
```

## Ash Correction

```{r}
#| label: correct for initial ash content

# Calculate ash mass and the ash correction factor
AshMass <- AshMass |>
  mutate(LitterMass = CrucibleLidLitter - CrucibleLid,
    AshMass = CrucibleLidAsh - CrucibleLid,
    ProportionAsh = AshMass/LitterMass)

# add ash data to LitterMass dataframe
LitterMass <- LitterMass |>
  left_join(
    AshMass |>
      select(LitterbagID, ProportionAsh),
    by = "LitterbagID"
  )

# calculate proportion of the intial litter (collection time 0) that is ash for each litter type
InitialAsh_Summary <- LitterMass |>
  filter(CollectionTime == 0) |>
  group_by(LitterType) |>
  summarize(
    N = n(),
    AshCorrection = mean(ProportionAsh, na.rm = TRUE),
    SD_AshCorrection = sd(ProportionAsh, na.rm = TRUE),
    SE_AshCorrection = SD_AshCorrection / sqrt(N)
  )

# apply ash correction to initial dry mass (after wet-dry and transport loss corrections)
LitterMass <- LitterMass |>
  left_join(
    InitialAsh_Summary |>
      select(LitterType, AshCorrection),
    by = "LitterType"
  ) |>
  mutate(
    InitialDryMass_AshAndTransCorrected = InitialDryMass_TransportCorrected * (1 - AshCorrection)
  )
```

## Final Dry Mass Calculations

```{r}
#| label: calculate-final-ash-free-dry-mass

LitterMass <- LitterMass |>
  mutate(FinalAshFreeDryMass = FinalDryMass * (1 - AshCorrection),
         PctAFDM_Remaining = (
           FinalAshFreeDryMass / InitialDryMass_AshAndTransCorrected) * 100
         )

# summary table of PctAFDM_Remaining by litter type and collection time
LitterMass_Summary <- LitterMass |>
  group_by(LitterType, CollectionTime) |>
  summarize(
    N = n(),
    Mean_PctAFDM_Remaining = mean(PctAFDM_Remaining, na.rm = TRUE),
    SD_PctAFDM_Remaining = sd(PctAFDM_Remaining, na.rm = TRUE),
    SE_PctAFDM_Remaining = SD_PctAFDM_Remaining / sqrt(N)
  )

```



```{r}

### IS THIS NEEDED?
#export WetDry as csv
#write_csv(WetDry,
#  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
#            "data", "TransportLoss_Summary.csv"))
```

