---
title: "OngavaDungMassLoss"
author: "Heather Throop"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Overview

This analysis script performs corrections on litter mass data from the Ongava Dung Decay experiment. The corrections include wet-dry correction, transport loss correction, and ash correction. The corrected mass data is then plotted to explore decomposition rates.

Written 2025-12-02 by Heather Throop

### Variable Names and Descriptions

#### Experimental design variables

`LitterbagID`: The unique identifier for each litterbag used in the experiment. Allowable values = M001 to M102 for mopane samples and D001 to D102 for dung samples.

`LitterType`: The type of litter being analyzed. Allowable values = mopane and dung.

`Block`: The block assigned to the litterbag. Litterbags were deployed in blocks of co-located litterbags (see "Ongava litterbag maps.pptx" for details). Allowable values = A - F.

`Microsite`: The microsite assigned to the litterbag. Allowable values = tree, open, NA. Tree microsites were under mopane canopies and open microsites were in open areas without tree canopy cover. Time 0 litterbags were not assigned to microsites and are indicated as NA.

`WaterTrt`:The water treatment assigned to the block that the litterbag was in. Allowable values = Ctrl, Addition, and NA. Time 0 litterbags were not assigned to a water treatment and are indicated as NA.

`Location`: The relative location within a block assigned to the litterbag to help in locating the bags for future collections (see "Ongava litterbag maps.pptx" for details). Allowable values = 1 - 8, NA. Time 0 litterbags were not assigned to a water treatment and are indicated as NA.

`CollectionTime`: The time point assigned for the litterbag to be collected. Allowable values = 0 - 6, with each 1 unit corresponding to 3 months.

`CollectionDate`: The date the litterbag was collected from the field. Format = YYYY-MM-DD.

`LitterbagStart`: The first litterbag number assigned to a particular WetDry correction sample. Allowable values = 1 - 102 for both dung and mopane.

`LitterbagEnd`: The last litterbag number assigned to a particular WetDry correction sample. Allowable values = 1 - 102 for both dung and mopane.

`Crucible`: The crucible number assigned to a particular ash mass sample. Allowable values = 1 - 15 for both dung and mopane.

`AshDate`: The date the ash mass sample was processed. Format = YYYY-MM-DD AM/PM.

#### Measured variables

`LitterbagMass`: The mass of the litterbag at the start of the experiment. Allowable values = 2.5-4 for dung and NA for mopane. Units = g.

`Litterbag_Litter`: The mass of the litterbag and the wet litter within the litterbag at the start of the experiment. Allowable values = 30-45 for dung and NA for mopane. Units = g. Dung was weighed within a litterbag while mopane was weighed in a weigh boat and then transferred to a litterbag.

`InitialWetMass`: The initial wet mass of the litter at the start of the experiment. Allowable values = 27.5-41 for dung and 3-3.5 for mopane. This is a calculated varibale for dung and a measure variable for mopane. Units = g.

`DryAndBoat`: The mass of the dried litter and the weigh boat after drying at the end of the experiment. Allowable values = 0-50 for dung and 0-20 for mopane. Units = g.

`Boat`: The mass of the weigh boat used to hold the mopane or dung litter during drying. Allowable values = 0-40. 0 indicates that the weigh boat was tared prior to weighing (boats were typically tared when there was only one balance user working at a time). Units = g.

`BagMass`: The mass of the empty bag used to hold the litter during wet-dry correction. Allowable values = 3 - 3.5. Units = g.

`WetMassAndBag`: The mass of the wet litter and the bag used to hold the litter during wet-dry correction. Allowable values = 5 - 50. Units = g.

`DryMassAndBag`: The mass of the dried litter and the bag used to hold the litter during wet-dry correction. Allowable values = 6 - 22. Units = g.

`CrucibleLid`: The mass of the crucible and lid before adding litter. Allowable values = 15 - 20 for both dung and mopane. Units = g.

`CrucibldLidLitter`: The mass of the crucible, lid, and dried litter before ashing. Allowable values = 18 - 30. Units = g.

`CrucibleLidAsh`: The mass of the crucible, lid, and ash after ashing. Allowable values = 18 - 30. Units = g.

#### Calculated variables

`WetDryCorrection`: The wet-dry correction factor calculated as the proportion of dry mass to wet mass for each litter type. This factor is used to convert initial wet mass to initial dry mass. Allowable values = 0.379 for dung and 0.907 for mopane. Unitless.

`InitialDryMass`: The initial dry mass of the litter at the start of the experiment (after wet-dry correction). InitialDryMass = InitialWetMass x ProportionDry. Allowable values = 10 - 16 for dung and 2.6 - 3.1 for mopane. Units = g.

`FinalDryMass`: The final dry mass of the litter at the end of the experiment (after wet-dry correction). FinalDryMass = DryAndBoat - Boat. Allowable values = 0 - 65. Units = g.

`TransportLossCorrection`: The transport loss correction factor calculated as the mean proportion of final dry mass to initial dry mass for time 0 litterbags for each litter type. This factor is used to correct initial dry mass for transport losses. Allowable values = 0.948 for dung and 0.998 for mopane. Unitless.

`InitialDryMass_TransportCorrected`: The initial dry mass of the litter at the start of the experiment after correcting for transport losses (mass loss in time 0 bags). InitialDryMass_TransportCorrected = InitialDryMass x TransportLossCorrection. Allowable values = 10 - 16 for dung and 2.6 - 3.1 for mopane. Units = g.

`ProportionAsh`: The proportion of ash in the litter calculated as the mass of ash divided by the mass of litter for each litterbag after collection. Allowable values = 0.01 - 1. Unitless.

`AshCorrection`: The ash correction factor calculated as the mean proportion of ash in time 0 litterbags for each litter type. This factor is used to correct initial dry mass for ash content. Allowable values = 0.088 for dung and 0.064 for mopane. Unitless.

`Initial_AFDM_TransCorrected`: The ash-free dry mass of the litter at the start of the experiment after correcting for transport losses and ash content. Initial_AFDM_TransCorrected = InitialDryMass_TransportCorrected x (1 - AshCorrection). Allowable values = 10 - 16 for dung and 2.6 - 3.1 for mopane. Units = g.

`Final_AFDM`: The ash-free dry mass of the litter at the end of the experiment after correcting for ash content. Final_AFDM = FinalDryMass x (1 - ProportionAsh). Allowable values = 0 - 16 for dung and 0 - 3.1 for mopane. Units = g.

`PctAFDM_Remaining`: The percentage of ash-free dry mass remaining at the end of the experiment. PctAFDM_Remaining = (Final_AFDM / Initial_AFDM_TransCorrected) \* 100. Allowable values = 0 - 100 for both dung and mopane. Units = %.

`WetMass`: The wet mass of the litter used in the wet-dry correction. WetMass = WetMassAndBag - BagMass. Allowable values = 3 - 50. Units = g.

`DryMass`: The dry mass of the litter used in the wet-dry correction. DryMass = DryMassAndBag - BagMass. Allowable values = 3 - 18. Units = g.

`ProportionDry`: The proportion of dry mass to wet mass for each litterbag used in the wet-dry correction. ProportionDry = DryMass / WetMass. Allowable values = 0.1 - 1. Unitless.

`LitterMass`: The mass of the litter used in the ash correction. LitterMass = CrucibleLidLitter - CrucibleLid. Allowable values = 3 - 18. Units = g.

`AshMass`: The mass of the ash remaining after ashing the litter. AshMass = CrucibleLidAsh - CrucibleLid. Allowable values = 0.01 - 5. Units = g.

## Preparation

```{r}
#| label: load-packages

library(tidyverse)
```

```{r}
#| label: config-setup

# This script uses a config.yml file to define the path for the DERT Data & Metadata folder (in Dropbox) where Heather has the data stored. This can be changed to your own path as needed or you can read in data from elsewhere, but you will need to update the read-in-files steps. 
DERT_Archives <- config::get()
```

```{r}
#| label: read-in-files

# Litter wet-dry mass data
WetDry <- read_csv(
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "WetDry.csv"), 
  show_col_types = FALSE)

# Litter mass data 
LitterMass <- read_csv(
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "LitterMass.csv"), 
  show_col_types = FALSE)
LitterMass <- LitterMass |>
  mutate(WaterTrt = as.factor(WaterTrt),
         Microsite = as.factor(Microsite),
         LitterType = as.factor(LitterType),
         Block = as.factor(Block))

# Ash data
AshMass <- read_csv(
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "AshMass.csv"), 
  show_col_types = FALSE)
```

## Wet-Dry Correction

```{r}
#| label: calculate wet-dry

# Calculate dry mass and the wet-dry correction factor
WetDry <- WetDry |>
  mutate(WetMass = WetMassAndBag - BagMass,
    DryMass = DryMassAndBag - BagMass,
    ProportionDry = DryMass/WetMass)
```

```{r}
#| label: summarize wet-dry

# simple plot of wet-dry correction by litterbag number for each litter type
p1 <- WetDry |> 
  filter(LitterType == "mopane") |>
  ggplot(aes(x = LitterbagStart, y = ProportionDry)) +
    geom_point() +
    labs(x = "Litterbag Number", y = "Wet-Dry Correction Factor") +
    theme_minimal() +
    ggtitle("Wet-Dry Correction for Mopane Litterbags")
p1

p2 <- WetDry |> 
  filter(LitterType == "dung") |>
  ggplot(aes(x = LitterbagStart, y = ProportionDry)) +
    geom_point() +
    labs(x = "Litterbag Number", y = "Wet-Dry Correction Factor") +
    theme_minimal() +
    ggtitle("Wet-Dry Correction for Dung Litterbags")
p2

# summarize wet-dry correction factor by litter type
WetDry_Summary <- WetDry |>
  group_by(LitterType) |>
  summarize(
    WetDryCorrection = mean(ProportionDry, na.rm = TRUE),
    SD_WetDryCorrect = sd(ProportionDry, na.rm = TRUE),
    N = n(),
    SE_WetDryCorrect = SD_WetDryCorrect / sqrt(N)
  )

```

```{r}
#| label: apply wet-dry correction

LitterMass <- LitterMass |>
  left_join(
    WetDry_Summary |>
      select(LitterType, WetDryCorrection),
    by = "LitterType"
  ) |>
  mutate(
    InitialDryMass = InitialWetMass * WetDryCorrection)
```

```{r}
#| label: calculate final dry mass
LitterMass <- LitterMass |>
  mutate(
    FinalDryMass = DryAndBoat - Boat)

```

## Transport Loss Correction

```{r}
#| label: plots to visualize transport loss

p3 <- LitterMass |> 
  filter(LitterType == "dung" & CollectionTime == 0) |>
  ggplot(aes(x = InitialDryMass, y = FinalDryMass)) +
    geom_point() +
    labs(x = "Initial Dry Mass (g)", y = "Final Dry Mass (g)") +
    theme_minimal() +
    ggtitle("Transport Loss for Dung Litterbags")
p3

p4 <- LitterMass |> 
  filter(LitterType == "mopane" & CollectionTime == 0) |>
  ggplot(aes(x = InitialDryMass, y = FinalDryMass)) +
    geom_point() +
    labs(x = "Initial Dry Mass (g)", y = "Final Dry Mass (g)") +
    theme_minimal() +
    ggtitle("Transport Loss for Mopane Litterbags")
p4

```

```{r}
#| label: calculate transport loss correction factor for each litter type

TransportLoss_Summary <- LitterMass |>
  filter(CollectionTime == 0) |>
  group_by(LitterType) |>
  summarize(
    TransportLossCorrection = mean(FinalDryMass / InitialDryMass, na.rm = TRUE),
    SD_TransportLossCorrect = sd(FinalDryMass / InitialDryMass, na.rm = TRUE),
    N = n(),
    SE_TransportLossCorrect = SD_TransportLossCorrect / sqrt(N)
  )

```

```{r}
#| label: Transport loss correction
LitterMass <- LitterMass |>
  # first add a column with the litter specific transport loss correction factor
  left_join(
    TransportLoss_Summary |>
      select(LitterType, TransportLossCorrection),
    by = "LitterType"
  ) |>
  # then calculate the transport loss corrected initial dry mass
  mutate(
    InitialDryMass_TransportCorrected = InitialDryMass * TransportLossCorrection
  )
```

## Ash Correction

```{r}
#| label: correct for initial ash content

# Calculate ash mass and the ash correction factor
AshMass <- AshMass |>
  mutate(LitterMass = CrucibleLidLitter - CrucibleLid,
    AshMass = CrucibleLidAsh - CrucibleLid,
    ProportionAsh = AshMass/LitterMass)

# add ash data to LitterMass dataframe
LitterMass <- LitterMass |>
  left_join(
    AshMass |>
      select(LitterbagID, ProportionAsh),
    by = "LitterbagID"
  )

# calculate proportion of the intial litter (collection time 0) that is ash for each litter type
InitialAsh_Summary <- LitterMass |>
  filter(CollectionTime == 0) |>
  group_by(LitterType) |>
  summarize(
    N = n(),
    AshCorrection = mean(ProportionAsh, na.rm = TRUE),
    SD_AshCorrection = sd(ProportionAsh, na.rm = TRUE),
    SE_AshCorrection = SD_AshCorrection / sqrt(N)
  )

# apply ash correction to initial dry mass (after wet-dry and transport loss corrections)
# using "AFDM" for 'ash-free dry mass'
LitterMass <- LitterMass |>
  left_join(
    InitialAsh_Summary |>
      select(LitterType, AshCorrection),
    by = "LitterType"
  ) |>
  mutate(
    Initial_AFDM_TransCorrected = InitialDryMass_TransportCorrected * (1 - AshCorrection)
  )
```

## Final Dry Mass Calculations

```{r}
#| label: calculate-final-ash-free-dry-mass

LitterMass <- LitterMass |>
  mutate(Final_AFDM = FinalDryMass * (1 - ProportionAsh),
         PctAFDM_Remaining = (
           Final_AFDM / Initial_AFDM_TransCorrected) * 100
         )

# summary table of PctAFDM_Remaining by litter type and collection time
LitterMass_Summary <- LitterMass |>
  group_by(CollectionTime, LitterType, Microsite, WaterTrt) |>
  summarize(
    N = sum(!is.na(PctAFDM_Remaining)),
    Mean_PctAFDM_Remaining = mean(PctAFDM_Remaining, na.rm = TRUE),
    SD_PctAFDM_Remaining = sd(PctAFDM_Remaining, na.rm = TRUE),
    SE_PctAFDM_Remaining = SD_PctAFDM_Remaining / sqrt(N)
  )






```

```{r}
#| label: plot-AFDM-remaining

# there are not treatments assigned to the time 0 data. Duplicate the data so that the data can be visualized for time 0
# pull out time0 data from the summary table
LitterMass_Summary_time0 <- LitterMass_Summary |>
  filter(CollectionTime == 0)

# define all possible combinations of variables
all_combos <- expand_grid(
  Microsite = c("open", "tree"),     
  WaterTrt  = c("Ctrl", "Addition")     
)
# expand the data so that there are values for all treatment combinations
LitterMass_Summary_expanded <- LitterMass_Summary_time0 |>
  ungroup() |>                           # remove grouping metadata
  select(-Microsite, -WaterTrt) |>       # now truly remove columns
  crossing(all_combos)  

# join tables together
LitterMass_Summary_no_time0 <- LitterMass_Summary |>
  filter(CollectionTime != 0)

LitterMass_Summary_final <- bind_rows(
  LitterMass_Summary_no_time0,
  LitterMass_Summary_expanded
)

# plot of mean percent AFDM remaining over time by litter type, microsite, and water treatment
p5 <- LitterMass_Summary_final |> 
  filter(!is.na(WaterTrt)) |>
  ggplot(aes(x = CollectionTime, 
             y = Mean_PctAFDM_Remaining, 
             color = LitterType,
             linetype = LitterType,
             shape = LitterType)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = Mean_PctAFDM_Remaining - SE_PctAFDM_Remaining,
                      ymax = Mean_PctAFDM_Remaining + SE_PctAFDM_Remaining),
                      width = 0.1,
                      color = "black",        
                      linetype = "solid") +
    scale_color_manual(values = c("brown", "darkgreen")) +
    scale_linetype_manual(values = c("solid", "dashed")) +
    scale_shape_manual(values = c(16, 17)) +
    facet_grid(Microsite ~ WaterTrt) +
    labs(x = "Collection Time", 
         y = "Mean Ash-Free Dry Mass Remaining (%)") +
    ggtitle("Ongava 2024 Decomposition Experiment") +
    theme_bw() +
    theme(
      panel.grid = element_blank(),              # remove all gridlines
      legend.position = c(0.98, 0.98),           # move inside upper-right
      legend.justification = c("right", "top"),  # anchor legend corner
      legend.background = element_rect(fill = alpha("white", 0.8))
    )
p5

p6 <- LitterMass_Summary_final |> 
  filter(!is.na(WaterTrt)) |>
  ggplot(aes(x = CollectionTime, 
             y = Mean_PctAFDM_Remaining, 
             color = WaterTrt,
             linetype = WaterTrt,
             shape = WaterTrt)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = Mean_PctAFDM_Remaining - SE_PctAFDM_Remaining,
                      ymax = Mean_PctAFDM_Remaining + SE_PctAFDM_Remaining),
                      width = 0.1,
                      color = "black",        
                      linetype = "solid") +
    scale_color_manual(values = c("blue", "black")) +
    scale_linetype_manual(values = c("solid", "dashed")) +
    scale_shape_manual(values = c(16, 17)) +
    facet_grid(LitterType ~ Microsite) +
    labs(x = "Collection Time", 
         y = "Mean Ash-Free Dry Mass Remaining (%)") +
    ggtitle("Ongava 2024 Decomposition Experiment") +
    theme_bw(base_size = 16) +
    theme(
      panel.grid = element_blank(),              # remove all gridlines
      legend.position = c(0.98, 0.98),           # move inside upper-right
      legend.justification = c("right", "top"),  # anchor legend corner
      legend.background = element_rect(fill = alpha("white", 0.8))
    )
p6
```

## Export Data

```{r}

# Export L2 data as csv.
# This is the L2 (level 2) data with all corrections applied and calculations made.

write_csv(LitterMass,
  file.path(DERT_Archives, "OngavaDungDecay","massloss_analyses",
            "data", "LitterMass_L2.csv"))
```
